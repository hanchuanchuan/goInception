(window.webpackJsonp=window.webpackJsonp||[]).push([[37],{438:function(_,t,v){"use strict";v.r(t);var a=v(44),s=Object(a.a)({},(function(){var _=this,t=_.$createElement,v=_._self._c||t;return v("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[v("h1",{attrs:{id:"备份功能"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#备份功能"}},[_._v("#")]),_._v(" 备份功能")]),_._v(" "),v("h2",{attrs:{id:"备份功能说明"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#备份功能说明"}},[_._v("#")]),_._v(" 备份功能说明")]),_._v(" "),v("p",[_._v("goInception自带备份功能，首先服务启动时配置config.toml(放在 "),v("code",[_._v("[inc]")]),_._v(" 段)")]),_._v(" "),v("table",[v("thead",[v("tr",[v("th",[_._v("参数")]),_._v(" "),v("th",[_._v("默认值")]),_._v(" "),v("th",[_._v("可选范围")]),_._v(" "),v("th",[_._v("说明")])])]),_._v(" "),v("tbody",[v("tr",[v("td",[_._v("backup_host")]),_._v(" "),v("td",[_._v('""')]),_._v(" "),v("td",[_._v("string")]),_._v(" "),v("td",[_._v("备份数据库IP地址")])]),_._v(" "),v("tr",[v("td",[_._v("backup_port")]),_._v(" "),v("td",[_._v("0")]),_._v(" "),v("td",[_._v("int")]),_._v(" "),v("td",[_._v("备份数据库端口")])]),_._v(" "),v("tr",[v("td",[_._v("backup_user")]),_._v(" "),v("td",[_._v('""')]),_._v(" "),v("td",[_._v("string")]),_._v(" "),v("td",[_._v("备份数据库用户名")])]),_._v(" "),v("tr",[v("td",[_._v("backup_password")]),_._v(" "),v("td",[_._v('""')]),_._v(" "),v("td",[_._v("string")]),_._v(" "),v("td",[_._v("备份数据库密码")])]),_._v(" "),v("tr",[v("td",[_._v("backup_tls "),v("code",[_._v("v1.4.0")])]),_._v(" "),v("td",[_._v('""')]),_._v(" "),v("td",[_._v("string")]),_._v(" "),v("td",[_._v("备份数据库ssl认证方式,可选值请参考 (https://github.com/go-sql-driver/mysql/issues/899#issuecomment-443493840)")])])])]),_._v(" "),v("p",[_._v("并且在执行sql时，添加 "),v("code",[_._v("--backup=true")]),_._v(" 或 "),v("code",[_._v("--backup=1")]),_._v(" 选项")]),_._v(" "),v("h2",{attrs:{id:"备份功能权限要求"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#备份功能权限要求"}},[_._v("#")]),_._v(" 备份功能权限要求")]),_._v(" "),v("ul",[v("li",[_._v("对"),v("code",[_._v("远程数据库")]),_._v("要求具有："),v("code",[_._v("REPLICATION CLIENT")]),_._v(","),v("code",[_._v("REPLICATION SLAVE")]),_._v(", 以进行binlog解析")]),_._v(" "),v("li",[_._v("对"),v("code",[_._v("备份数据库")]),_._v("要求具有："),v("code",[_._v("CREATE")]),_._v(","),v("code",[_._v("INSERT")]),_._v(",建议给所有权限, 便于生成备份")])]),_._v(" "),v("h3",{attrs:{id:"示例"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#示例"}},[_._v("#")]),_._v(" 示例")]),_._v(" "),v("div",{staticClass:"language-sql extra-class"},[v("pre",{pre:!0,attrs:{class:"language-sql"}},[v("code",[v("span",{pre:!0,attrs:{class:"token comment"}},[_._v("/*--user=root;--password=root;--host=127.0.0.1;--port=3306;--execute=1;--backup=1;*/")]),_._v("\ninception_magic_start"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v(";")]),_._v("\n"),v("span",{pre:!0,attrs:{class:"token keyword"}},[_._v("use")]),_._v(" test"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v(";")]),_._v("\n"),v("span",{pre:!0,attrs:{class:"token keyword"}},[_._v("create")]),_._v(" "),v("span",{pre:!0,attrs:{class:"token keyword"}},[_._v("table")]),_._v(" t1"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v("(")]),_._v("id "),v("span",{pre:!0,attrs:{class:"token keyword"}},[_._v("int")]),_._v(" "),v("span",{pre:!0,attrs:{class:"token keyword"}},[_._v("primary")]),_._v(" "),v("span",{pre:!0,attrs:{class:"token keyword"}},[_._v("key")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v(")")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v(";")]),_._v("\ninception_magic_commit"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v(";")]),_._v("\n")])])]),v("h2",{attrs:{id:"备份功能写入规则"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#备份功能写入规则"}},[_._v("#")]),_._v(" 备份功能写入规则")]),_._v(" "),v("ul",[v("li",[_._v("在备份服务器上，备份库的命名格式为："),v("code",[_._v("IP_PORT_库名")]),_._v("，例如"),v("code",[_._v("127_0_0_1_3306_test")])]),_._v(" "),v("li",[_._v("在备份库上创建备份信息表"),v("code",[_._v("$_$Inception_backup_information$_$")]),_._v("，用来保存该库的执行信息和回滚语句信息")])]),_._v(" "),v("table",[v("thead",[v("tr",[v("th",[_._v("字段名")]),_._v(" "),v("th",[_._v("类型")]),_._v(" "),v("th",[_._v("说明")])])]),_._v(" "),v("tbody",[v("tr",[v("td",[_._v("opid_time")]),_._v(" "),v("td",[_._v("varchar(50)")]),_._v(" "),v("td",[_._v("执行操作ID,格式为"),v("code",[_._v("时间戳_线程号_执行序号")])])]),_._v(" "),v("tr",[v("td",[_._v("start_binlog_file")]),_._v(" "),v("td",[_._v("varchar(512)")]),_._v(" "),v("td",[_._v("起始binlog文件")])]),_._v(" "),v("tr",[v("td",[_._v("start_binlog_pos")]),_._v(" "),v("td",[_._v("int(11)")]),_._v(" "),v("td",[_._v("起始binlog位置")])]),_._v(" "),v("tr",[v("td",[_._v("end_binlog_file")]),_._v(" "),v("td",[_._v("varchar(512)")]),_._v(" "),v("td",[_._v("终止binlog文件")])]),_._v(" "),v("tr",[v("td",[_._v("end_binlog_pos")]),_._v(" "),v("td",[_._v("int(11)")]),_._v(" "),v("td",[_._v("终止binlog位置")])]),_._v(" "),v("tr",[v("td",[_._v("sql_statement")]),_._v(" "),v("td",[_._v("text")]),_._v(" "),v("td",[_._v("执行SQL")])]),_._v(" "),v("tr",[v("td",[_._v("host")]),_._v(" "),v("td",[_._v("varchar(64)")]),_._v(" "),v("td",[_._v("执行IP地址")])]),_._v(" "),v("tr",[v("td",[_._v("dbname")]),_._v(" "),v("td",[_._v("varchar(64)")]),_._v(" "),v("td",[_._v("执行库名")])]),_._v(" "),v("tr",[v("td",[_._v("tablename")]),_._v(" "),v("td",[_._v("varchar(64)")]),_._v(" "),v("td",[_._v("执行表名")])]),_._v(" "),v("tr",[v("td",[_._v("port")]),_._v(" "),v("td",[_._v("int(11)")]),_._v(" "),v("td",[_._v("执行端口")])]),_._v(" "),v("tr",[v("td",[_._v("time")]),_._v(" "),v("td",[_._v("timestamp")]),_._v(" "),v("td",[_._v("执行时间")])]),_._v(" "),v("tr",[v("td",[_._v("type")]),_._v(" "),v("td",[_._v("varchar(20)")]),_._v(" "),v("td",[_._v("操作类型")])])])]),_._v(" "),v("ul",[v("li",[_._v("在备份库有和操作表相同的表名，其表结构统一为：")])]),_._v(" "),v("table",[v("thead",[v("tr",[v("th",[_._v("字段名")]),_._v(" "),v("th",[_._v("类型")]),_._v(" "),v("th",[_._v("说明")])])]),_._v(" "),v("tbody",[v("tr",[v("td",[_._v("id")]),_._v(" "),v("td",[_._v("bigint")]),_._v(" "),v("td",[_._v("自增主键")])]),_._v(" "),v("tr",[v("td",[_._v("rollback_statement")]),_._v(" "),v("td",[_._v("mediumtext")]),_._v(" "),v("td",[_._v("回滚语句")])]),_._v(" "),v("tr",[v("td",[_._v("opid_time")]),_._v(" "),v("td",[_._v("varchar(50)")]),_._v(" "),v("td",[_._v("关联执行操作ID")])])])]),_._v(" "),v("h2",{attrs:{id:"备份功能详细步骤"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#备份功能详细步骤"}},[_._v("#")]),_._v(" 备份功能详细步骤")]),_._v(" "),v("ol",[v("li",[_._v("配置备份数据库，并在执行SQL时开启备份功能")]),_._v(" "),v("li",[_._v("在执行SQL前记录binlog位置和线程号(逐条执行逐条记录)")]),_._v(" "),v("li",[_._v("执行SQL")]),_._v(" "),v("li",[_._v("在执行SQL后记录binlog位置和线程号")]),_._v(" "),v("li",[_._v("开始备份，解析远程服务器binlog")]),_._v(" "),v("li",[_._v("在备份服务器创建备份库")]),_._v(" "),v("li",[_._v("创建备份信息表，写入执行信息和binlog位置信息")]),_._v(" "),v("li",[_._v("创建备份表，")]),_._v(" "),v("li",[_._v("逐步解析binlog，并生成回滚语句，写入备份表")])])])}),[],!1,null,null,null);t.default=s.exports}}]);